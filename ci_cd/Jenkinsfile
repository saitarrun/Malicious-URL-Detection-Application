pipeline {
    agent any
    environment {
        DOCKERHUB_CREDENTIALS = credentials('dockerhub-creds')
        REGISTRY = 'your-dockerhub-username/malicious-url-detector'
    }
    stages {
        stage('Lint Backend') {
            steps {
                sh 'cd malicious_url_app_scaffold/backend && source .venv/bin/activate && flake8 src/'
            }
        }
        stage('Test Backend') {
            steps {
                sh 'cd malicious_url_app_scaffold/backend && source .venv/bin/activate && pytest src/api_v1/'
            }
        }
        stage('Test Frontend') {
            steps {
                sh 'cd malicious_url_app_scaffold/frontend && npm install && npm run test'
            }
        }
        stage('Build Docker Images') {
            steps {
                sh 'docker-compose build'
            }
        }
        stage('Push Images') {
            steps {
                sh 'docker login -u $DOCKERHUB_CREDENTIALS_USR -p $DOCKERHUB_CREDENTIALS_PSW'
                sh 'docker-compose push'
            }
        }
        stage('Deploy to K8s') {
            steps {
                sh 'kubectl apply -f malicious_url_app_scaffold/k8s/'
            }
        }
    }
}
